# pybdshadow - Building shadow analysis

![1649074615552.png](https://github.com/ni1o1/pybdshadow/raw/main/image/README/1649074615552.png)

[![Documentation Status](https://readthedocs.org/projects/pybdshadow/badge/?version=latest)](https://pybdshadow.readthedocs.io/en/latest/?badge=latest) [![Downloads](https://pepy.tech/badge/pybdshadow)](https://pepy.tech/project/pybdshadow) [![codecov](https://codecov.io/gh/ni1o1/pybdshadow/branch/main/graph/badge.svg?token=GLAVYYCD9L)](https://codecov.io/gh/ni1o1/pybdshadow) [![Tests](https://github.com/ni1o1/pybdshadow/actions/workflows/tests.yml/badge.svg)](https://github.com/ni1o1/pybdshadow/actions/workflows/tests.yml)

## Introduction

`pybdshadow` is a python package to analyze building shadow.   
The latest stable release of the software can be installed via pip and full documentation can be found [here](https://pybdshadow.readthedocs.io/en/latest/).

## Example

Detail usage can be found in [this example](https://github.com/ni1o1/pybdshadow/blob/main/example/example.ipynb).

### Shadow generated by Sun light

`pybdshadow` is capable of generating shadows from building outline data. Building outline data can be obtain by Python package [OSMnx](https://osmnx.readthedocs.io/en/stable/) from OpenStreetMap. 
The buildings are usually store in the data as the form of Polygon object with `height` column.

```python
import pandas as pd
import geopandas as gpd
#Read building data
buildings = gpd.read_file(r'data/bd_demo.json')
buildings
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>height</th>
      <th>x</th>
      <th>y</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>42</td>
      <td>139.698802</td>
      <td>35.533816</td>
      <td>POLYGON ((139.69831 35.53380, 139.69831 35.533...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>9</td>
      <td>139.698402</td>
      <td>35.534030</td>
      <td>POLYGON ((139.69799 35.53417, 139.69799 35.533...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>45</td>
      <td>139.698491</td>
      <td>35.534637</td>
      <td>POLYGON ((139.69864 35.53445, 139.69863 35.534...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>9</td>
      <td>139.698784</td>
      <td>35.534735</td>
      <td>POLYGON ((139.69864 35.53477, 139.69866 35.534...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>90</td>
      <td>139.700506</td>
      <td>35.536064</td>
      <td>POLYGON ((139.70015 35.53590, 139.70039 35.535...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1369</th>
      <td>27826</td>
      <td>5</td>
      <td>139.708790</td>
      <td>35.552112</td>
      <td>POLYGON ((139.70876 35.55223, 139.70869 35.552...</td>
    </tr>
    <tr>
      <th>1370</th>
      <td>27827</td>
      <td>43</td>
      <td>139.706311</td>
      <td>35.551746</td>
      <td>POLYGON ((139.70637 35.55183, 139.70621 35.551...</td>
    </tr>
    <tr>
      <th>1371</th>
      <td>27828</td>
      <td>16</td>
      <td>139.705786</td>
      <td>35.551667</td>
      <td>POLYGON ((139.70583 35.55179, 139.70572 35.551...</td>
    </tr>
    <tr>
      <th>1372</th>
      <td>27829</td>
      <td>14</td>
      <td>139.708900</td>
      <td>35.551267</td>
      <td>POLYGON ((139.70867 35.55133, 139.70867 35.551...</td>
    </tr>
    <tr>
      <th>1373</th>
      <td>27830</td>
      <td>16</td>
      <td>139.708320</td>
      <td>35.550467</td>
      <td>POLYGON ((139.70837 35.55071, 139.70823 35.550...</td>
    </tr>
  </tbody>
</table>
<p>1374 rows × 5 columns</p>
</div>

Given a building GeoDataFrame and UTC datetime, `pybdshadow` can calculate the building shadow based on the sun position obtained by `suncalc`

```python
import pybdshadow
#Given UTC datetime
date = pd.to_datetime('2015-01-01 02:45:33.959797119')
#Calculate building shadow for sun light
shadows = pybdshadow.bdshadow_sunlight(buildings,date)
shadows
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>building_id</th>
      <th>geometry</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>POLYGON ((139.69831 35.53380, 139.69831 35.533...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>POLYGON ((139.69881 35.53389, 139.69881 35.533...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>POLYGON ((139.69837 35.53484, 139.69837 35.535...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>POLYGON ((139.69864 35.53477, 139.69864 35.534...</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>POLYGON ((139.70015 35.53590, 139.70016 35.535...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1366</th>
      <td>1366</td>
      <td>POLYGON ((139.70882 35.55199, 139.70882 35.551...</td>
    </tr>
    <tr>
      <th>1367</th>
      <td>1367</td>
      <td>POLYGON ((139.70621 35.55182, 139.70621 35.552...</td>
    </tr>
    <tr>
      <th>1368</th>
      <td>1368</td>
      <td>POLYGON ((139.70570 35.55159, 139.70570 35.551...</td>
    </tr>
    <tr>
      <th>1369</th>
      <td>1369</td>
      <td>POLYGON ((139.70867 35.55133, 139.70867 35.551...</td>
    </tr>
    <tr>
      <th>1370</th>
      <td>1370</td>
      <td>POLYGON ((139.70823 35.55070, 139.70823 35.550...</td>
    </tr>
  </tbody>
</table>
<p>1371 rows × 2 columns</p>
</div>



`pybdshadow` also provide visualization method supported by keplergl.

```python
# visualize buildings and shadows
pybdshadow.show_bdshadow(buildings = buildings,shadows = shadows)
```

![1649161376291.png](https://github.com/ni1o1/pybdshadow/raw/main/image/README/1649161376291.png)


### Shadow generated by Point light

`pybdshadow` can also calculate the building shadow generated by point light. Given coordinates and height of the point light:

```python
#Calculate building shadow for point light
shadows = pybdshadow.bdshadow_pointlight(buildings,139.713319,35.552040,200)
#Visualize buildings and shadows
pybdshadow.show_bdshadow(buildings = buildings,shadows = shadows)
```

![1649405838683.png](https://github.com/ni1o1/pybdshadow/raw/main/image/README/1649405838683.png)

### Billboard visual area analyze

To analyze billboard visual area, the parameter `ad_params` for the billboard should be defined. It has two forms:

```python
#1. Given the coordinates of brandCenter, orientation and height
ad_params = {'orientation': 1.2806657381630058,
            'height': 10,
            'brandCenter': [139.71259, 35.552842999999996]} 
#2. Given the coordinates of the two border points and height
ad_params = {'point1': [139.711861, 35.552040],
            'point2': [139.713319, 35.553646],#1861,3646
            'height': 50,
            }
```

We can calculate the visual area of the billboard using `ad_visualArea`.

```python
#calculate the visual area
visualArea,shadows = pybdshadow.ad_visualArea(ad_params,buildings)
```

Then, visualize the billboard and the visual area.

```python
#Generate a GeoDataFrame from ad_params for visualization
billboard_gdf = pybdshadow.ad_to_gdf(ad_params,billboard_height = 100)
#Visualize buildings, shadows, billboard and visual area
pybdshadow.show_bdshadow(buildings=buildings,
                         shadows=shadows,
                         ad=billboard_gdf,
                         ad_visualArea=visualArea)
```

![1649406044109.png](https://github.com/ni1o1/pybdshadow/raw/main/image/README/1649406044109.png)

## Installation

It is recommended to use `Python 3.7, 3.8, 3.9`

### Using pypi [![PyPI version](https://badge.fury.io/py/pybdshadow.svg)](https://badge.fury.io/py/pybdshadow)

`pybdshadow` can be installed by using `pip install`. Before installing `pybdshadow`, make sure that you have installed the available [geopandas package](https://geopandas.org/en/stable/getting_started/install.html). If you already have geopandas installed, run the following code directly from the command prompt to install `pybdshadow`:

```python
pip install pybdshadow
```

## Dependency

`pybdshadow` depends on the following packages

* `numpy`
* `pandas`
* `shapely`
* `rtree`
* `geopandas`
* `matplotlib`
* [`suncalc`](https://github.com/kylebarron/suncalc-py)
* `keplergl`

## Citation information

Citation information can be found at [CITATION.cff](https://github.com/ni1o1/pybdshadow/blob/main/CITATION.cff).

## Contributing to pybdshadow [![GitHub contributors](https://img.shields.io/github/contributors/ni1o1/pybdshadow.svg)](https://github.com/ni1o1/pybdshadow/graphs/contributors) ![GitHub commit activity](https://img.shields.io/github/commit-activity/m/ni1o1/pybdshadow)

All contributions, bug reports, bug fixes, documentation improvements, enhancements and ideas are welcome. A detailed overview on how to contribute can be found in the [contributing guide](https://github.com/ni1o1/pybdshadow/blob/master/CONTRIBUTING.md) on GitHub.
